# SPDX-FileCopyrightText: 2025 Taras Paruta (partarstu@gmail.com)
#
# SPDX-License-Identifier: Apache-2.0

steps:

  # Build the base image
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'agentic-qa-base:latest', '-f', 'Dockerfile.base', '.' ]

  # Build the orchestrator image
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/orchestrator', '-f', 'orchestrator/Dockerfile', '.' ]

  # Build the requirements-review-agent image
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/requirements-review-agent', '-f', 'agents/requirements_review/Dockerfile', '.' ]

  # Build the test-case-generation-agent image
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/test-case-generation-agent', '-f', 'agents/test_case_generation/Dockerfile', '.' ]

  # Build the test-case-classification-agent image
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/test-case-classification-agent', '-f', 'agents/test_case_classification/Dockerfile', '.' ]

  # Build the test-case-review-agent image
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/test-case-review-agent', '-f', 'agents/test_case_review/Dockerfile', '.' ]

  # Build the incident-creation-agent image
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/incident-creation-agent', '-f', 'agents/incident_creation/Dockerfile', '.' ]

  # Build the jira-rag-agent image
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/jira-rag-agent', '-f', 'agents/jira_rag/Dockerfile', '.' ]

  # Push the orchestrator image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', 'gcr.io/$PROJECT_ID/orchestrator' ]

  # Push the requirements-review-agent image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', 'gcr.io/$PROJECT_ID/requirements-review-agent' ]

  # Push the test-case-generation-agent image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', 'gcr.io/$PROJECT_ID/test-case-generation-agent' ]

  # Push the test-case-classification-agent image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', 'gcr.io/$PROJECT_ID/test-case-classification-agent' ]

  # Push the test-case-review-agent image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', 'gcr.io/$PROJECT_ID/test-case-review-agent' ]

  # Push the incident-creation-agent image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', 'gcr.io/$PROJECT_ID/incident-creation-agent' ]

  # Push the jira-rag-agent image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', 'gcr.io/$PROJECT_ID/jira-rag-agent' ]

  # Pull, tag, push, and deploy jira-mcp-server to Cloud Run (conditional)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$_DEPLOY_ALL_SERVICES" = "true" ] || [ "$_DEPLOY_JIRA_MCP" = "true" ]; then
          echo "Pulling mcp-atlassian image from GitHub Container Registry..."
          docker pull ghcr.io/sooperset/mcp-atlassian:0.11.12 && \
          echo "Tagging mcp-atlassian image for Google Container Registry..." && \
          docker tag ghcr.io/sooperset/mcp-atlassian:0.11.12 gcr.io/$PROJECT_ID/mcp-atlassian:latest && \
          echo "Pushing mcp-atlassian image to Container Registry..." && \
          docker push gcr.io/$PROJECT_ID/mcp-atlassian:latest && \
          echo "Deploying jira-mcp-server to Cloud Run..." && \
          gcloud beta run deploy jira-mcp-server \
            --image=gcr.io/$PROJECT_ID/mcp-atlassian:latest \
            --network=agent-network \
            --subnet=agent-network \
            --ingress=internal \
            --vpc-egress=private-ranges-only \
            --platform=managed \
            --region=us-central1 \
            --allow-unauthenticated \
            --memory=1Gi \
            --max-instances=1 \
            --set-secrets=JIRA_API_TOKEN=JIRA_API_TOKEN:latest,JIRA_USERNAME=JIRA_USERNAME:latest,JIRA_URL=JIRA_URL:latest \
            --set-env-vars=TZ=$_TIMEZONE,MCP_LOGGING_STDOUT=true,DISABLE_JIRA_MARKUP_TRANSLATION=true \
            --port=9000 \
            --args=--transport,sse,--port,9000,-v \
            --add-volume=type=cloud-storage,name=jira-volume,bucket=$_BUCKET_NAME,mount-options=only-dir=$_JIRA_ATTACHMENTS_FOLDER \
            --add-volume-mount=volume=jira-volume,mount-path=$_JIRA_MCP_SERVER_ATTACHMENTS_MOUNT_PATH \
            --concurrency=100
        else
          echo "Skipping jira-mcp-server pull/tag/push/deploy (variable _DEPLOY_JIRA_MCP and _DEPLOY_ALL_SERVICES are not true)"
        fi

  # Build, push, and deploy embedding-service to Cloud Run (conditional)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$_DEPLOY_ALL_SERVICES" = "true" ] || [ "$_DEPLOY_EMBEDDING_SERVICE" = "true" ]; then
          echo "Building embedding-service image..."
          docker build -t gcr.io/$PROJECT_ID/embedding-service -f services/embedding_service/Dockerfile . && \
          echo "Pushing embedding-service image to Container Registry..." && \
          docker push gcr.io/$PROJECT_ID/embedding-service && \
          echo "Deploying embedding-service to Cloud Run..." && \
          gcloud beta run deploy embedding-service \
            --image=gcr.io/$PROJECT_ID/embedding-service \
            --network=agent-network \
            --subnet=agent-network \
            --ingress=internal \
            --vpc-egress=private-ranges-only \
            --platform=managed \
            --region=us-central1 \
            --allow-unauthenticated \
            --memory=8Gi \
            --max-instances=1 \
            --port=8080 \
            --set-env-vars=TZ=$_TIMEZONE \
            --concurrency=5
        else
          echo "Skipping embedding-service build/push/deploy (variable _DEPLOY_EMBEDDING_SERVICE and _DEPLOY_ALL_SERVICES are not true)"
        fi

  # Build, push, and deploy prompt-guard-service to Cloud Run (conditional)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$_DEPLOY_ALL_SERVICES" = "true" ] || [ "$_DEPLOY_PROMPT_GUARD" = "true" ]; then
          echo "Building prompt-guard-service image..."
          docker build -t gcr.io/$PROJECT_ID/prompt-guard-service -f services/prompt_guard_service/Dockerfile . && \
          echo "Pushing prompt-guard-service image to Container Registry..." && \
          docker push gcr.io/$PROJECT_ID/prompt-guard-service && \
          echo "Deploying prompt-guard-service to Cloud Run..." && \
          gcloud beta run deploy prompt-guard-service \
            --image=gcr.io/$PROJECT_ID/prompt-guard-service \
            --network=agent-network \
            --subnet=agent-network \
            --ingress=internal \
            --vpc-egress=private-ranges-only \
            --platform=managed \
            --region=us-central1 \
            --allow-unauthenticated \
            --memory=2Gi \
            --max-instances=1 \
            --port=8080 \
            --set-env-vars=TZ=$_TIMEZONE \
            --concurrency=5
        else
          echo "Skipping prompt-guard-service build/push/deploy (variable _DEPLOY_PROMPT_GUARD and _DEPLOY_ALL_SERVICES are not true)"
        fi


  # Deploy Qdrant Vector DB to Cloud Run (conditional)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$_DEPLOY_ALL_SERVICES" = "true" ] || [ "$_DEPLOY_QDRANT" = "true" ]; then
          echo "Deploying qdrant-vector-db to Cloud Run..."
          gcloud beta run deploy qdrant-vector-db \
            --image=qdrant/qdrant:v1.16.3 \
            --network=agent-network \
            --subnet=agent-network \
            --vpc-egress=private-ranges-only \
            --platform=managed \
            --region=us-central1 \
            --allow-unauthenticated \
            --memory=2Gi \
            --cpu=1 \
            --max-instances=1 \
            --use-http2 \
            --port=6334 \
            --add-volume=type=cloud-storage,name=qdrant-storage,bucket=$_BUCKET_NAME,mount-options=only-dir=$_QDRANT_STORAGE_FOLDER \
            --add-volume-mount=volume=qdrant-storage,mount-path=/qdrant/storage \
            --set-secrets=QDRANT__SERVICE__API_KEY=QDRANT_API_KEY:latest \
            --set-env-vars=TZ=$_TIMEZONE \
            --concurrency=5
        else
          echo "Skipping qdrant-vector-db deployment (variable _DEPLOY_QDRANT and _DEPLOY_ALL_SERVICES are not true)"
        fi

  # Deploy to Cloud Run orchestrator
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'beta'
      - 'run'
      - 'deploy'
      - 'orchestrator'
      - '--image=gcr.io/$PROJECT_ID/orchestrator'
      - '--platform=managed'
      - '--network=agent-network'
      - '--subnet=agent-network'
      - '--vpc-egress=all-traffic'
      - '--region=us-central1'
      - '--allow-unauthenticated'
      - '--memory=4Gi'
      - '--max-instances=1'
      - '--concurrency=5'
      - '--set-env-vars=^;^REMOTE_EXECUTION_AGENT_HOSTS=$_REMOTE_EXECUTION_AGENT_HOSTS'
      - '--set-env-vars=TZ=$_TIMEZONE,AGENT_DISCOVERY_PORTS=443-443,GOOGLE_CLOUD_LOGGING_ENABLED=true,QDRANT_URL=$_QDRANT_URL,QDRANT_GRPC_PORT=443,ATTACHMENTS_LOCAL_DESTINATION_FOLDER_PATH=$_LOCAL_ATTACHMENTS_MOUNT_PATH,MCP_SERVER_ATTACHMENTS_FOLDER_PATH=$_JIRA_MCP_SERVER_ATTACHMENTS_MOUNT_PATH,DASHBOARD_JWT_EXPIRE_HOURS=24'
      - '--set-secrets=GOOGLE_API_KEY=GOOGLE_API_KEY:latest,JIRA_API_TOKEN=JIRA_API_TOKEN:latest,JIRA_USERNAME=JIRA_USERNAME:latest,ZEPHYR_API_TOKEN=ZEPHYR_API_TOKEN:latest,JIRA_URL=JIRA_URL:latest,ZEPHYR_BASE_URL=ZEPHYR_BASE_URL:latest,ORCHESTRATOR_API_KEY=ORCHESTRATOR_API_KEY:latest,QDRANT_API_KEY=QDRANT_API_KEY:latest,DASHBOARD_USERNAME=DASHBOARD_USERNAME:latest,DASHBOARD_PASSWORD=DASHBOARD_PASSWORD:latest,DASHBOARD_JWT_SECRET=DASHBOARD_JWT_SECRET:latest'
      - '--add-volume=type=cloud-storage,name=gcs-allure-reports,bucket=$_ALLURE_REPORTS_BUCKET'
      - '--add-volume-mount=volume=gcs-allure-reports,mount-path=$_ALLURE_REPORTS_CONTAINER_PATH'
      - '--add-volume=type=cloud-storage,name=jira-volume,bucket=$_BUCKET_NAME,mount-options=only-dir=$_JIRA_ATTACHMENTS_FOLDER'
      - '--add-volume-mount=volume=jira-volume,mount-path=$_LOCAL_ATTACHMENTS_MOUNT_PATH'
      - '--timeout=$_ORCHESTRATOR_REQUEST_TIMEOUT'

  # Deploy to Cloud Run requirements-review-agent
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'requirements-review-agent'
      - '--image=gcr.io/$PROJECT_ID/requirements-review-agent'
      - '--platform=managed'
      - '--ingress=internal'
      - '--network=agent-network'
      - '--subnet=agent-network'
      - '--vpc-egress=all-traffic'
      - '--region=us-central1'
      - '--allow-unauthenticated'
      - '--memory=3Gi'
      - '--max-instances=1'
      - '--concurrency=2'
      - '--set-secrets=GOOGLE_API_KEY=GOOGLE_API_KEY:latest,JIRA_API_TOKEN=JIRA_API_TOKEN:latest,JIRA_USERNAME=JIRA_USERNAME:latest,ZEPHYR_API_TOKEN=ZEPHYR_API_TOKEN:latest,JIRA_URL=JIRA_URL:latest,JIRA_MCP_SERVER_URL=JIRA_MCP_SERVER_URL:latest,ZEPHYR_BASE_URL=ZEPHYR_BASE_URL:latest'
      - '--set-env-vars=TZ=$_TIMEZONE,GOOGLE_CLOUD_LOGGING_ENABLED=true,AGENT_BASE_URL=$_REQUIREMENTS_REVIEW_AGENT_BASE_URL,EXTERNAL_PORT=443,EMBEDDING_SERVICE_URL=$_EMBEDDING_SERVICE_URL,PROMPT_GUARD_SERVICE_URL=$_PROMPT_GUARD_SERVICE_URL,ATTACHMENTS_LOCAL_DESTINATION_FOLDER_PATH=$_LOCAL_ATTACHMENTS_MOUNT_PATH,MCP_SERVER_ATTACHMENTS_FOLDER_PATH=$_JIRA_MCP_SERVER_ATTACHMENTS_MOUNT_PATH'
      - '--port=8001'
      - '--add-volume=type=cloud-storage,name=jira-volume,bucket=$_BUCKET_NAME,mount-options=only-dir=$_JIRA_ATTACHMENTS_FOLDER'
      - '--add-volume-mount=volume=jira-volume,mount-path=$_LOCAL_ATTACHMENTS_MOUNT_PATH'

  # Deploy to Cloud Run test-case-generation-agent
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'test-case-generation-agent'
      - '--image=gcr.io/$PROJECT_ID/test-case-generation-agent'
      - '--platform=managed'
      - '--ingress=internal'
      - '--network=agent-network'
      - '--subnet=agent-network'
      - '--vpc-egress=all-traffic'
      - '--region=us-central1'
      - '--allow-unauthenticated'
      - '--memory=3Gi'
      - '--max-instances=1'
      - '--concurrency=2'
      - '--set-secrets=GOOGLE_API_KEY=GOOGLE_API_KEY:latest,JIRA_API_TOKEN=JIRA_API_TOKEN:latest,JIRA_USERNAME=JIRA_USERNAME:latest,ZEPHYR_API_TOKEN=ZEPHYR_API_TOKEN:latest,JIRA_URL=JIRA_URL:latest,JIRA_MCP_SERVER_URL=JIRA_MCP_SERVER_URL:latest,ZEPHYR_BASE_URL=ZEPHYR_BASE_URL:latest'
      - '--set-env-vars=TZ=$_TIMEZONE,GOOGLE_CLOUD_LOGGING_ENABLED=true,AGENT_BASE_URL=$_TEST_CASE_GENERATION_AGENT_BASE_URL,EXTERNAL_PORT=443,EMBEDDING_SERVICE_URL=$_EMBEDDING_SERVICE_URL,PROMPT_GUARD_SERVICE_URL=$_PROMPT_GUARD_SERVICE_URL,ATTACHMENTS_LOCAL_DESTINATION_FOLDER_PATH=$_LOCAL_ATTACHMENTS_MOUNT_PATH,MCP_SERVER_ATTACHMENTS_FOLDER_PATH=$_JIRA_MCP_SERVER_ATTACHMENTS_MOUNT_PATH'
      - '--port=8001'
      - '--add-volume=type=cloud-storage,name=jira-volume,bucket=$_BUCKET_NAME,mount-options=only-dir=$_JIRA_ATTACHMENTS_FOLDER'
      - '--add-volume-mount=volume=jira-volume,mount-path=$_LOCAL_ATTACHMENTS_MOUNT_PATH'

  # Deploy to Cloud Run test-case-classification-agent
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'test-case-classification-agent'
      - '--image=gcr.io/$PROJECT_ID/test-case-classification-agent'
      - '--platform=managed'
      - '--ingress=internal'
      - '--network=agent-network'
      - '--subnet=agent-network'
      - '--vpc-egress=all-traffic'
      - '--region=us-central1'
      - '--allow-unauthenticated'
      - '--memory=3Gi'
      - '--max-instances=1'
      - '--concurrency=2'
      - '--set-secrets=GOOGLE_API_KEY=GOOGLE_API_KEY:latest,JIRA_API_TOKEN=JIRA_API_TOKEN:latest,JIRA_USERNAME=JIRA_USERNAME:latest,ZEPHYR_API_TOKEN=ZEPHYR_API_TOKEN:latest,JIRA_URL=JIRA_URL:latest,JIRA_MCP_SERVER_URL=JIRA_MCP_SERVER_URL:latest,ZEPHYR_BASE_URL=ZEPHYR_BASE_URL:latest'
      - '--set-env-vars=TZ=$_TIMEZONE,GOOGLE_CLOUD_LOGGING_ENABLED=true,AGENT_BASE_URL=$_TEST_CASE_CLASSIFICATION_AGENT_BASE_URL,EXTERNAL_PORT=443,EMBEDDING_SERVICE_URL=$_EMBEDDING_SERVICE_URL,PROMPT_GUARD_SERVICE_URL=$_PROMPT_GUARD_SERVICE_URL,ATTACHMENTS_LOCAL_DESTINATION_FOLDER_PATH=$_LOCAL_ATTACHMENTS_MOUNT_PATH,MCP_SERVER_ATTACHMENTS_FOLDER_PATH=$_JIRA_MCP_SERVER_ATTACHMENTS_MOUNT_PATH'
      - '--port=8001'
      - '--add-volume=type=cloud-storage,name=jira-volume,bucket=$_BUCKET_NAME,mount-options=only-dir=$_JIRA_ATTACHMENTS_FOLDER'
      - '--add-volume-mount=volume=jira-volume,mount-path=$_LOCAL_ATTACHMENTS_MOUNT_PATH'

  # Deploy to Cloud Run test-case-review-agent
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'test-case-review-agent'
      - '--image=gcr.io/$PROJECT_ID/test-case-review-agent'
      - '--platform=managed'
      - '--ingress=internal'
      - '--network=agent-network'
      - '--subnet=agent-network'
      - '--vpc-egress=all-traffic'
      - '--region=us-central1'
      - '--allow-unauthenticated'
      - '--memory=3Gi'
      - '--max-instances=1'
      - '--concurrency=2'
      - '--set-secrets=GOOGLE_API_KEY=GOOGLE_API_KEY:latest,JIRA_API_TOKEN=JIRA_API_TOKEN:latest,JIRA_USERNAME=JIRA_USERNAME:latest,ZEPHYR_API_TOKEN=ZEPHYR_API_TOKEN:latest,JIRA_URL=JIRA_URL:latest,JIRA_MCP_SERVER_URL=JIRA_MCP_SERVER_URL:latest,ZEPHYR_BASE_URL=ZEPHYR_BASE_URL:latest'
      - '--set-env-vars=TZ=$_TIMEZONE,GOOGLE_CLOUD_LOGGING_ENABLED=true,AGENT_BASE_URL=$_TEST_CASE_REVIEW_AGENT_BASE_URL,EXTERNAL_PORT=443,EMBEDDING_SERVICE_URL=$_EMBEDDING_SERVICE_URL,PROMPT_GUARD_SERVICE_URL=$_PROMPT_GUARD_SERVICE_URL,ATTACHMENTS_LOCAL_DESTINATION_FOLDER_PATH=$_LOCAL_ATTACHMENTS_MOUNT_PATH,MCP_SERVER_ATTACHMENTS_FOLDER_PATH=$_JIRA_MCP_SERVER_ATTACHMENTS_MOUNT_PATH'
      - '--port=8001'
      - '--add-volume=type=cloud-storage,name=jira-volume,bucket=$_BUCKET_NAME,mount-options=only-dir=$_JIRA_ATTACHMENTS_FOLDER'
      - '--add-volume-mount=volume=jira-volume,mount-path=$_LOCAL_ATTACHMENTS_MOUNT_PATH'

  # Deploy to Cloud Run incident-creation-agent
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'beta'
      - 'run'
      - 'deploy'
      - 'incident-creation-agent'
      - '--image=gcr.io/$PROJECT_ID/incident-creation-agent'
      - '--platform=managed'
      - '--ingress=internal'
      - '--network=agent-network'
      - '--subnet=agent-network'
      - '--vpc-egress=all-traffic'
      - '--region=us-central1'
      - '--allow-unauthenticated'
      - '--memory=3Gi'
      - '--max-instances=1'
      - '--concurrency=2'
      - '--set-secrets=GOOGLE_API_KEY=GOOGLE_API_KEY:latest,JIRA_API_TOKEN=JIRA_API_TOKEN:latest,JIRA_USERNAME=JIRA_USERNAME:latest,ZEPHYR_API_TOKEN=ZEPHYR_API_TOKEN:latest,JIRA_URL=JIRA_URL:latest,JIRA_MCP_SERVER_URL=JIRA_MCP_SERVER_URL:latest,ZEPHYR_BASE_URL=ZEPHYR_BASE_URL:latest,QDRANT_API_KEY=QDRANT_API_KEY:latest'
      - '--set-env-vars=TZ=$_TIMEZONE,GOOGLE_CLOUD_LOGGING_ENABLED=true,AGENT_BASE_URL=$_INCIDENT_CREATION_AGENT_BASE_URL,EXTERNAL_PORT=443,EMBEDDING_SERVICE_URL=$_EMBEDDING_SERVICE_URL,PROMPT_GUARD_SERVICE_URL=$_PROMPT_GUARD_SERVICE_URL,QDRANT_URL=$_QDRANT_URL,QDRANT_PORT=443,QDRANT_GRPC_PORT=443,ATTACHMENTS_LOCAL_DESTINATION_FOLDER_PATH=$_LOCAL_ATTACHMENTS_MOUNT_PATH,MCP_SERVER_ATTACHMENTS_FOLDER_PATH=$_JIRA_MCP_SERVER_ATTACHMENTS_MOUNT_PATH'
      - '--add-volume=type=cloud-storage,name=jira-volume,bucket=$_BUCKET_NAME,mount-options=only-dir=$_JIRA_ATTACHMENTS_FOLDER'
      - '--add-volume-mount=volume=jira-volume,mount-path=$_LOCAL_ATTACHMENTS_MOUNT_PATH'
      - '--port=8001'

  # Deploy to Cloud Run jira-rag-agent
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'jira-rag-agent'
      - '--image=gcr.io/$PROJECT_ID/jira-rag-agent'
      - '--platform=managed'
      - '--ingress=internal'
      - '--network=agent-network'
      - '--subnet=agent-network'
      - '--vpc-egress=all-traffic'
      - '--region=us-central1'
      - '--allow-unauthenticated'
      - '--memory=3Gi'
      - '--max-instances=1'
      - '--concurrency=2'
      - '--set-secrets=GOOGLE_API_KEY=GOOGLE_API_KEY:latest,JIRA_API_TOKEN=JIRA_API_TOKEN:latest,JIRA_USERNAME=JIRA_USERNAME:latest,ZEPHYR_API_TOKEN=ZEPHYR_API_TOKEN:latest,JIRA_URL=JIRA_URL:latest,JIRA_MCP_SERVER_URL=JIRA_MCP_SERVER_URL:latest,ZEPHYR_BASE_URL=ZEPHYR_BASE_URL:latest,QDRANT_API_KEY=QDRANT_API_KEY:latest'
      - '--set-env-vars=TZ=$_TIMEZONE,GOOGLE_CLOUD_LOGGING_ENABLED=true,AGENT_BASE_URL=$_JIRA_RAG_AGENT_BASE_URL,EXTERNAL_PORT=443,EMBEDDING_SERVICE_URL=$_EMBEDDING_SERVICE_URL,PROMPT_GUARD_SERVICE_URL=$_PROMPT_GUARD_SERVICE_URL,QDRANT_URL=$_QDRANT_URL,QDRANT_PORT=443,QDRANT_GRPC_PORT=443,ATTACHMENTS_LOCAL_DESTINATION_FOLDER_PATH=$_LOCAL_ATTACHMENTS_MOUNT_PATH,MCP_SERVER_ATTACHMENTS_FOLDER_PATH=$_JIRA_MCP_SERVER_ATTACHMENTS_MOUNT_PATH'
      - '--port=8001'
      - '--add-volume=type=cloud-storage,name=jira-volume,bucket=$_BUCKET_NAME,mount-options=only-dir=$_JIRA_ATTACHMENTS_FOLDER'
      - '--add-volume-mount=volume=jira-volume,mount-path=$_LOCAL_ATTACHMENTS_MOUNT_PATH'

substitutions:
  _TIMEZONE: 'Europe/Vienna'
  _DEPLOY_ALL_SERVICES: 'false'
  _DEPLOY_JIRA_MCP: 'false'
  _DEPLOY_EMBEDDING_SERVICE: 'false'
  _DEPLOY_PROMPT_GUARD: 'false'
  _DEPLOY_QDRANT: 'false'
  _JIRA_ATTACHMENTS_FOLDER: 'jira'
  _LOCAL_ATTACHMENTS_MOUNT_PATH: '/tmp'
  _JIRA_MCP_SERVER_ATTACHMENTS_MOUNT_PATH: '/tmp'
  _BUCKET_NAME: ''
  _ALLURE_REPORTS_CONTAINER_PATH: '/app/allure-report'
  _ALLURE_REPORTS_BUCKET: ''
  _REMOTE_EXECUTION_AGENT_HOSTS: ''
  _REQUIREMENTS_REVIEW_AGENT_BASE_URL: ''
  _TEST_CASE_CLASSIFICATION_AGENT_BASE_URL: ''
  _TEST_CASE_GENERATION_AGENT_BASE_URL: ''
  _TEST_CASE_REVIEW_AGENT_BASE_URL: ''
  _INCIDENT_CREATION_AGENT_BASE_URL: ''
  _JIRA_RAG_AGENT_BASE_URL: ''
  _ORCHESTRATOR_REQUEST_TIMEOUT: '3500s'
  _EMBEDDING_SERVICE_URL: ''
  _PROMPT_GUARD_SERVICE_URL: ''
  _QDRANT_URL: ''
  _QDRANT_STORAGE_FOLDER: 'qdrant'

images:
  - 'gcr.io/$PROJECT_ID/requirements-review-agent'
  - 'gcr.io/$PROJECT_ID/test-case-generation-agent'
  - 'gcr.io/$PROJECT_ID/test-case-classification-agent'
  - 'gcr.io/$PROJECT_ID/test-case-review-agent'
  - 'gcr.io/$PROJECT_ID/incident-creation-agent'
  - 'gcr.io/$PROJECT_ID/jira-rag-agent'
  - 'gcr.io/$PROJECT_ID/orchestrator'

options:
  logging: CLOUD_LOGGING_ONLY
